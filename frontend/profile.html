<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Perfil do Usu치rio</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen flex flex-col items-center justify-start p-6 transition-colors duration-500
  bg-gradient-to-br from-gray-100 via-white to-gray-200 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900
  text-gray-900 dark:text-gray-100">

  <!-- Header -->
  <div class="w-full max-w-6xl flex justify-between items-center mb-8">
    <h1 class="text-4xl font-extrabold bg-gradient-to-r from-blue-500 to-indigo-600 bg-clip-text text-transparent tracking-tight cursor-pointer" onclick="window.location.href='news.html'">fokos</h1>
    <div class="flex gap-3">
      <button id="theme-toggle" class="px-4 py-2 rounded-xl bg-gray-700 dark:bg-gray-300 hover:bg-gray-800 dark:hover:bg-gray-400 transition text-white dark:text-gray-800 font-medium shadow-md">游깿</button>
      <button onclick="logout()" class="px-5 py-2.5 rounded-xl bg-red-500 hover:bg-red-600 transition text-white font-medium shadow-md">Sair</button>
    </div>
  </div>

  <div id="profile-container" class="max-w-3xl w-full mx-auto bg-white/80 dark:bg-gray-900/90 p-8 rounded-2xl shadow-lg">
    <div class="flex flex-col items-center gap-4 mb-8">
      <img id="profile-avatar" src="" alt="avatar" class="w-28 h-28 rounded-full border-4 border-blue-500 shadow">
      <div class="text-center">
        <h1 id="profile-name" class="text-3xl font-extrabold text-gray-900 dark:text-gray-100"></h1>
        <div class="text-blue-600 dark:text-blue-400 text-lg font-mono" id="profile-username"></div>
        <div class="text-gray-500 dark:text-gray-400 mt-1" id="profile-bio"></div>
      </div>
      <div class="flex gap-6 mt-2 text-center">
        <div><span id="profile-fok-count" class="font-bold text-xl"></span><div class="text-xs text-gray-500">Foks</div></div>
        <div><span id="profile-followers" class="font-bold text-xl"></span><div class="text-xs text-gray-500">Seguidores</div></div>
        <div><span id="profile-following" class="font-bold text-xl"></span><div class="text-xs text-gray-500">Seguindo</div></div>
        <div><span id="profile-likes" class="font-bold text-xl"></span><div class="text-xs text-gray-500">Likes dados</div></div>
        <div><span id="profile-likes-received" class="font-bold text-xl"></span><div class="text-xs text-gray-500">Likes recebidos</div></div>
      </div>
    </div>
    <h2 style="display: flex; gap: 3px;" class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">Foks de <p id="profile-username-2"></p></h2>
    <ul id="profile-foks" class="space-y-6"></ul>
  </div>

  <!-- Modal de Detalhes da Not칤cia -->
  <div id="news-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 hidden">
    <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl max-w-lg w-full p-6 relative">
      <button id="close-modal" class="absolute top-3 right-3 text-gray-500 hover:text-red-500 text-2xl">&times;</button>
      <div id="modal-news-content">
        <!-- Conte칰do da not칤cia ser치 inserido aqui -->
      </div>
      <div class="mt-4">
        <h3 class="font-semibold mb-2">Coment치rios</h3>
        <ul id="modal-comments" class="space-y-2 max-h-40 overflow-y-auto"></ul>
        <div class="flex gap-2 mt-2">
          <input id="modal-comment-input" type="text" placeholder="Adicionar coment치rio..." class="flex-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100">
          <button id="modal-comment-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Comentar</button>
        </div>
      </div>
    </div>
  </div>
  </div>

  <script src="js/theme.js"></script>
  <script>

    const API_URL = 'http://localhost:8000/api/v1';
    // Pega username da URL
    function getUsernameFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('u');
    }

    // Fun칞칚o global para abrir modal de not칤cia
    async function openNewsModal(newsId) {
      const modal = document.getElementById('news-modal');
      const modalContent = document.getElementById('modal-news-content');
      const commentsList = document.getElementById('modal-comments');
      const commentInput = document.getElementById('modal-comment-input');
      const commentBtn = document.getElementById('modal-comment-btn');
      modal.classList.remove('hidden');
      modalContent.innerHTML = '<div class="text-center py-8">Carregando...</div>';
      commentsList.innerHTML = '';
      commentInput.value = '';
      commentBtn.disabled = true;

      // Buscar detalhes da not칤cia
      const res = await fetch(`${API_URL}/news/${newsId}`, {
          method: 'GET',
          headers: {'Content-Type': 'application/json'},
      });
      const news = await res.json();
      const n = news.data || {};
      let likeCount = n.likes_count || 0;

      // Exibir avatar, username, data, likes
      modalContent.innerHTML = `
          <div class="flex items-center gap-3 mb-2">
              <img src="${n.avatar || '/s/i/avatar-default.png'}" alt="avatar" class="w-10 h-10 rounded-full border border-gray-300 dark:border-gray-700">
              <div>
                  <div class="font-semibold text-gray-800 dark:text-gray-100">${n.author || ''} <span class="text-sm text-gray-500">@${n.username || ''}</span></div>
                  <div class="text-xs text-gray-500">${n.created_at_human || ''}</div>
              </div>
          </div>
          <h2 class="text-2xl font-bold mb-1">${n.title || ''}</h2>
          <p class="mb-3 text-gray-800 dark:text-gray-200">${n.content || ''}</p>
          <div class="flex items-center gap-3 mb-2">
          </div>
      `;

    // --- CACHE COMENT츼RIOS ---
    const commentsCacheKey = `comments_news_${newsId}`;
    const commentsCacheStr = localStorage.getItem(commentsCacheKey);
    let comments = null;
    let now = Date.now();
    if (commentsCacheStr) {
      try {
        const cache = JSON.parse(commentsCacheStr);
        if (cache.expire > now) {
          comments = cache.data;
        } else {
          localStorage.removeItem(commentsCacheKey);
        }
      } catch {}
    }
    if (!comments) {
      const resComments = await fetch(`${API_URL}/news/${newsId}/comment`, {
        headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('token') || '') }
      });
      comments = await resComments.json();
      localStorage.setItem(commentsCacheKey, JSON.stringify({ data: comments, expire: now + 30000 })); // 30s
    }
    commentsList.innerHTML = comments.data && comments.data.length ? comments.data.map(c => {
      let username = (c.user && c.user.username) ? c.user.username : (c.username || c.author || 'Usu치rio');
      let avatar = (c.user && c.user.avatar) ? c.user.avatar : '';
      return `<li class=\"bg-gray-100 dark:bg-gray-800 rounded-lg px-3 py-2 flex items-center gap-2\">${avatar ? `<img src=\"${avatar}\" alt=\"avatar\" class=\"w-7 h-7 rounded-full border border-gray-300 dark:border-gray-700\">` : ''}<b>${username}:</b> ${c.content}</li>`;
    }).join('') : '<li class=\"text-gray-500\">Nenhum coment치rio ainda.</li>';

      // Habilitar bot칚o comentar
      commentInput.oninput = () => {
          commentBtn.disabled = !commentInput.value.trim();
      };
      commentBtn.disabled = true;
    commentBtn.onclick = async () => {
      const content = commentInput.value.trim();
      if (!content) return;
      await fetch(`${API_URL}/news/${newsId}/comment`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + (localStorage.getItem('token') || '')
        },
        body: JSON.stringify({ content })
      });
      commentInput.value = '';
      commentBtn.disabled = true;
      // Atualizar coment치rios e cache
      const resComments = await fetch(`${API_URL}/news/${newsId}/comment`, {
        headers: { 'Authorization': 'Bearer ' + (localStorage.getItem('token') || '') }
      });
      const comments = await resComments.json();
      localStorage.setItem(`comments_news_${newsId}`, JSON.stringify({ data: comments, expire: Date.now() + 30000 }));
      commentsList.innerHTML = comments.data && comments.data.length ? comments.data.map(c => {
        let username = (c.user && c.user.username) ? c.user.username : (c.username || c.author || 'Usu치rio');
        let avatar = (c.user && c.user.avatar) ? c.user.avatar : '';
        return `<li class=\"bg-gray-100 dark:bg-gray-800 rounded-lg px-3 py-2 flex items-center gap-2\">${avatar ? `<img src=\"${avatar}\" alt=\"avatar\" class=\"w-7 h-7 rounded-full border border-gray-300 dark:border-gray-700\">` : ''}<b>${username}:</b> ${c.content}</li>`;
      }).join('') : '<li class=\"text-gray-500\">Nenhum coment치rio ainda.</li>';
    };
    }

    // Fun칞칚o para carregar o perfil
    async function loadProfile() {
      const username = getUsernameFromUrl();
      if (!username) {
        document.getElementById('profile-container').innerHTML = '<div class="text-center text-red-500">Usu치rio n칚o especificado.</div>';
        return;
      }
      try {
        const res = await fetch(`${API_URL}/user/username/${encodeURIComponent(username)}`);
        if (!res.ok) throw new Error('Usu치rio n칚o encontrado');
        const response = await res.json();
        const data = response.data;
        document.getElementById('profile-avatar').src = data.avatar || '/s/i/avatar-default.png';
        document.getElementById('profile-name').innerText = data.name || '';
        document.getElementById('profile-username').innerText = '@' + (data.username || '');
        document.getElementById('profile-bio').innerText = data.bio || '';
        document.getElementById('profile-fok-count').innerText = data.stats.fok_count ?? 0;
        document.getElementById('profile-followers').innerText = data.stats.seguidores ?? 0;
        document.getElementById('profile-following').innerText = data.stats.seguindo ?? 0;
        document.getElementById('profile-likes').innerText = data.stats.likes_count ?? 0;
        document.getElementById('profile-likes-received').innerText = data.stats.likes_received_count ?? 0;
        document.getElementById('profile-username-2').innerText = '@' + (data.username || '');

        // Renderizar foks
        const foksList = document.getElementById('profile-foks');
        foksList.innerHTML = '';
        if (data.foks && data.foks.length) {
          data.foks.forEach(fok => {
            foksList.innerHTML += `
              <li class="p-5 bg-white/80 dark:bg-gray-800/90 rounded-2xl shadow-md dark:text-gray-100 transition-colors duration-500 cursor-pointer hover:ring-2 ring-blue-400" onclick="openNewsModal(${fok.id})">
                <strong class="text-gray-800 dark:text-gray-100">${fok.title}</strong>
                <span class="text-sm text-gray-600 dark:text-gray-400"> - ${fok.created_at_human}</span>
                <p class="mt-1 text-gray-700 dark:text-gray-300">${fok.content}</p>
              </li>
            `;
          });
        } else {
          foksList.innerHTML = '<li class="text-gray-500">Nenhum fok encontrado.</li>';
        }
      } catch (e) {
        document.getElementById('profile-container').innerHTML = '<div class="text-center text-red-500">Usu치rio n칚o encontrado.</div>';
      }
    }

    // Modal: fechar ao clicar no X ou fora
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('close-modal').onclick = () => {
        document.getElementById('news-modal').classList.add('hidden');
      };
      document.getElementById('news-modal').addEventListener('click', e => {
        if (e.target === document.getElementById('news-modal')) {
          document.getElementById('news-modal').classList.add('hidden');
        }
      });
    });

    loadProfile();
  </script>
</body>
</html>
